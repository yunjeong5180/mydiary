<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>✍️ 새 일기 작성</title>

    <link rel="stylesheet" href="/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
</head>

<body>

<!-- ─── 상단 네비게이션 바 ───────────────────────── -->
<nav class="nav-bar">
    <h1 class="nav-title">📘 나의 일기장</h1>
    <div class="nav-menu">
        <a href="/index.html">🏠 홈</a>
        <a href="/list.html">📋 목록</a>
    </div>
</nav>

<!-- ─── 본문 : 일기 작성 ─────────────────────────── -->
<main class="main-content">
    <h2>✍️ 새 일기 작성하기</h2>

    <form id="diary-form">
        <input type="text" id="title" placeholder="제목" required>
        <textarea id="content" placeholder="내용" required></textarea>
        <button type="submit">저장</button>
    </form>
</main>

<!-- ✅ 로그인 필요 모달 구조 -->
<div id="modal-backdrop"></div>
<div id="modal-box">
    <p>로그인이 필요합니다 😅</p>
    <button id="modal-ok">로그인하러 가기</button>
</div>

<!-- ─── 스크립트 ─────────────────────────────────── -->
<script>
    // ✅ 로그인 상태 확인
    async function checkLogin() {
        const res = await fetch("/users/me", { credentials: "include" });
        if (!res.ok) {
            document.getElementById("modal-backdrop").style.display = "block";
            document.getElementById("modal-box").style.display = "block";
        }
    }

    checkLogin(); // 페이지 진입 시 로그인 체크

    // ✅ 일기 저장 처리
    const form = document.getElementById("diary-form");
    const title = document.getElementById("title");
    const text  = document.getElementById("content");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const diary = {
            title: title.value,
            content: text.value
        };

        const res = await fetch("/diaries", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify(diary)
        });

        if (res.ok) {
            alert("일기가 저장되었습니다!");
            title.value = "";
            text.value = "";
        } else if (res.status === 401) {
            document.getElementById("modal-backdrop").style.display = "block";
            document.getElementById("modal-box").style.display = "block";
        } else {
            alert("저장 실패: " + await res.text());
        }
    });

    // ✅ 모달 버튼 동작
    document.getElementById("modal-ok").onclick = () => {
        location.href = "/login.html";
    };
</script>

</body>
</html>
