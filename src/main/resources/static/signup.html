<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>📝 회원가입</title>
    <link rel="stylesheet" href="/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
    <style>
        /* 회원가입 폼 스타일 (외부 style.css에 정의하는 것이 좋습니다) */
        .main-content {
            max-width: 600px; /* 로그인 폼보다 넓게 */
            margin: 40px auto;
            padding: 30px 40px; /* 좌우 패딩 증가 */
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            background-color: #fff;
        }
         .main-content h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #333;
        }
        /* 폼 그룹 스타일 */
        .form-group {
          display: flex;
          flex-wrap: wrap; /* 화면 작을 때 줄바꿈 허용 */
          align-items: center;
          margin-bottom: 15px; /* 여백 증가 */
        }
        /* 왼쪽 라벨 스타일 */
        .form-group label {
          width: 120px; /* 너비 조정 */
          font-weight: bold;
          padding-right: 15px; /* 라벨과 입력 필드 사이 여백 */
          box-sizing: border-box;
          font-size: 0.95em; /* 글자 크기 살짝 조정 */
        }
        /* 오른쪽 입력창 (input, select) 공통 스타일 */
        .form-group input,
        .form-group select {
          flex: 1; /* 남은 공간 차지 */
          min-width: 200px; /* 최소 너비 설정 */
          padding: 10px; /* 패딩 조정 */
          border: 1px solid #ccc;
          border-radius: 4px;
          box-sizing: border-box;
        }
        /* 힌트 설명 텍스트 */
        .form-note {
          width: 100%; /* 너비 100% */
          font-size: 0.85em; /* 글자 크기 조정 */
          color: #666; /* 색상 변경 */
          /* margin 수정: form-group 다음에 오도록 하고 왼쪽 마진 제거 */
          margin: -5px 0 10px 0; /* 위쪽 마진 줄이고, 아래쪽, 왼쪽 마진 조정 */
          padding-left: 135px; /* 라벨 너비 + 라벨 오른쪽 패딩 만큼 들여쓰기 */
          box-sizing: border-box;
        }
        /* 비밀번호 일치/불일치 메시지 */
        #passwordMatchMsg {
          margin-left: 10px;
          font-weight: bold;
          font-size: 0.9em;
          flex-shrink: 0; /* 메시지가 줄어들지 않도록 */
        }
        /* 회원가입 버튼 */
        button[type="submit"] {
            width: 100%;
            padding: 12px;
            background-color: #28a745; /* 녹색 계열 */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 20px; /* 위쪽 여백 */
            transition: background-color 0.2s;
        }
        button[type="submit"]:hover {
            background-color: #218838;
        }
        /* 오류 메시지 */
        #msg {
            color: red;
            margin-top: 15px;
            text-align: center;
            font-size: 0.9em;
            min-height: 1.2em;
        }
        /* 로그인 링크 */
        p.login-link-container { /* 클래스 추가 및 스타일 조정 */
             text-align: center;
             margin-top: 25px; /* 여백 증가 */
        }
        p.login-link-container a {
            color: #007bff;
            text-decoration: none;
            font-weight: bold; /* 강조 */
        }
        p.login-link-container a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>

<nav class="nav-bar">
    <h1 class="nav-title">📘 나의 일기장</h1>
</nav>

<main class="main-content">
    <h2>📝 회원가입</h2>

    <form id="signupForm">
        <div class="form-group">
            <label for="name">이름</label>
            <input name="name" id="name" required>
        </div>

        <div class="form-group">
            <label for="birth">생년월일</label>
            <input name="birth" id="birth" type="date" required>
        </div>

        <div class="form-group">
            <label for="gender">성별</label>
            <select name="gender" id="gender" required>
                <option value="" disabled selected>성별 선택</option>
                <option value="male">남자</option>
                <option value="female">여자</option>
                <option value="other">기타</option>
            </select>
        </div>

        <div class="form-group">
            <label for="email">이메일</label>
            <input name="email" id="email" type="email" required>
        </div>

        <div class="form-group">
            <label for="phone">연락처</label>
            <input name="phone" id="phone" type="tel" placeholder="예: 010-1234-5678" required>
        </div>

        <div class="form-group">
            <label for="username">아이디</label>
            <input name="username" id="username" required minlength="4">
        </div>
        <div class="form-note">4자 이상 입력해주세요.</div>

        <div class="form-group">
            <label for="password">비밀번호</label>
            <input name="password" id="password" type="password" required minlength="6">
        </div>
        <div class="form-note">6자 이상 입력해주세요.</div>

        <div class="form-group">
            <label for="confirmPassword">비밀번호 확인</label>
            <input name="confirmPassword" id="confirmPassword" type="password" required>
            <span id="passwordMatchMsg"></span>
        </div>

        <button type="submit">회원가입 완료</button>
    </form> <p id="msg"></p>

    <p class="login-link-container">
        이미 계정이 있으신가요?
        <a href="/login.html" id="loginLink">로그인하러 가기 →</a>
    </p>
</main>

<script>
    const passwordInput = document.getElementById("password");
    const confirmInput = document.getElementById("confirmPassword");
    const matchMsg = document.getElementById("passwordMatchMsg");
    const signupForm = document.getElementById('signupForm');
    const msgElem = document.getElementById("msg");
    const loginLink = document.getElementById("loginLink");

    // 페이지 로드 시 URL에서 redirect 파라미터 읽기
    const urlParams = new URLSearchParams(location.search);
    const redirectTo = urlParams.get("redirect"); // URLSearchParams가 자동 디코딩

    // 로그인 링크 URL 설정 (redirect 파라미터 포함)
    let baseLoginUrl = '/login.html';
    if (redirectTo) {
        try {
            // 경로 유효성 검사
            if ((redirectTo.startsWith('/') || redirectTo.endsWith('.html')) && !redirectTo.includes(':')) {
                baseLoginUrl = `/login.html?redirect=${encodeURIComponent(redirectTo)}`;
            } else {
                console.warn("Invalid redirect parameter detected for login link:", redirectTo);
            }
        } catch (e) {
            console.error("Error processing redirect for login link:", e);
        }
    }
    loginLink.href = baseLoginUrl;


    // ✅ 비밀번호 일치 실시간 체크 함수
    function checkPasswordMatch() {
        if (confirmInput.value === "") {
            matchMsg.textContent = "";
            confirmInput.style.borderColor = '#ccc'; // 기본 테두리
        } else if (passwordInput.value === confirmInput.value) {
            matchMsg.textContent = "✔ 일치!";
            matchMsg.style.color = "green";
            confirmInput.style.borderColor = 'green'; // 일치 시 녹색
        } else {
            matchMsg.textContent = "❌ 불일치";
            matchMsg.style.color = "red";
            confirmInput.style.borderColor = 'red'; // 불일치 시 빨간색
        }
    }
    // 이벤트 리스너 연결
    confirmInput.addEventListener("input", checkPasswordMatch);
    passwordInput.addEventListener("input", checkPasswordMatch);


    // ✅ 회원가입 폼 제출 처리
    signupForm.onsubmit = async (e) => {
        e.preventDefault(); // 기본 동작 중단
        msgElem.textContent = ''; // 오류 메시지 초기화

        // 최종 유효성 검사 (Submit 시점)
        if (passwordInput.value !== confirmInput.value) {
            msgElem.textContent = "❌ 비밀번호가 일치하지 않습니다.";
            confirmInput.focus();
            return;
        }
        if (passwordInput.value.length < 6) {
             msgElem.textContent = "❌ 비밀번호는 6자 이상이어야 합니다.";
             passwordInput.focus();
             return;
        }
        // 아이디 길이 검사 등 추가 가능

        // 폼 데이터 준비
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        delete data.confirmPassword; // 확인용 비밀번호 필드 제거

        // API URL 생성 (절대 경로)
        const signupUrl = `${location.origin}/users/signup`;

        try {
            // 서버에 회원가입 요청
            const res = await fetch(signupUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            // 응답 처리
            if (res.ok) {
                // 회원가입 성공
                alert("회원가입이 완료되었습니다! 로그인 페이지로 이동합니다.");
                // 로그인 페이지로 리디렉션 (redirect 파라미터 포함된 URL 사용)
                location.href = loginLink.href; // 위에서 설정한 loginLink.href 사용

            } else {
                // 회원가입 실패
                let errorText = '회원가입에 실패했습니다. 입력 정보를 확인해주세요.'; // 기본 메시지
                 try {
                    // 서버 응답에서 구체적인 오류 메시지 추출 시도
                    if (res.headers.get('content-type')?.includes('application/json')) {
                        const errorJson = await res.json();
                        errorText = errorJson.message || errorText;
                    } else {
                         const text = await res.text();
                         if(text) errorText = text;
                    }
                 } catch (parseError) {
                    console.error("Error parsing signup error response:", parseError);
                 }
                 msgElem.textContent = `❌ ${errorText} (Status: ${res.status})`;
            }
        } catch (error) {
            // 네트워크 오류 등 fetch 실패
            console.error('Signup fetch error:', error);
            msgElem.textContent = '회원가입 중 오류가 발생했습니다. 네트워크 연결을 확인해주세요.';
        }
    };
</script>

</body>
</html>
