<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“‹ ì¼ê¸° ëª©ë¡</title>
  <link rel="stylesheet" href="/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
</head>

<body>

<nav class="nav-bar">
  <h1 class="nav-title">ğŸ“˜ ë‚˜ì˜ ì¼ê¸°ì¥</h1>
  <div class="nav-menu">
    <a href="/index.html">ğŸ  í™ˆ</a>
    <a href="/write.html">âœï¸ ì‘ì„±</a>
    <button id="logoutBtn" style="margin-left:10px; display: none;">Logout</button>
  </div>
</nav>

<main class="main-content">
  <h2>ğŸ“‹ ì¼ê¸° ëª©ë¡</h2>
  <label for="sort">ì •ë ¬:</label>
  <select id="sort">
    <option value="desc">ìµœì‹ ìˆœ</option>
    <option value="asc">ì˜¤ë˜ëœìˆœ</option>
  </select>
  <ul id="diary-list"></ul>
</main>

<!-- âœ… ë¡œê·¸ì¸ ì•ˆë‚´ ëª¨ë‹¬ -->
<div id="modal-backdrop" style="display: none;">
  <div id="modal-box" style="display: none;">
    <p>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤ ğŸ˜…</p>
    <button id="modal-ok">ë¡œê·¸ì¸í•˜ëŸ¬ ê°€ê¸°</button>
  </div>
</div>

<script>
  // âœ… ë¡œê·¸ì¸ í™•ì¸ â†’ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í‘œì‹œ & ëª©ë¡ ë¡œë“œ
  fetch("/users/me", { credentials: "include" })
    .then(res => {
      if (res.ok) {
        document.getElementById("logoutBtn").style.display = "inline-block";
        loadDiaries();
      } else {
        document.getElementById("modal-backdrop").style.display = "block";
        document.getElementById("modal-box").style.display = "block"; // âœ… ì¶”ê°€!
      }
    });

  // âœ… ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ë™ì‘
  document.getElementById("logoutBtn").onclick = async () => {
    await fetch('/users/logout', { method: 'POST', credentials: 'include' });
    location.href = '/login.html';
  };

  document.getElementById("modal-ok").onclick = () => {
    location.href = "/login.html";
  };

  const diaryList = document.getElementById("diary-list");

  async function deleteDiary(id) {
    const res = await fetch(`/diaries/${id}`, {
      method: "DELETE",
      credentials: "include"
    });
    if (res.ok) loadDiaries();
    else if (res.status === 401) {
      document.getElementById("modal-backdrop").style.display = "block";
      document.getElementById("modal-box").style.display = "block"; // âœ… ì¶”ê°€!
    }
  }

  async function loadDiaries() {
    const sort = document.getElementById("sort").value;
    const res = await fetch(`/diaries?sort=${sort}`, {
      credentials: "include"
    });

    if (res.status === 401) {
      document.getElementById("modal-backdrop").style.display = "block";
      document.getElementById("modal-box").style.display = "block"; // âœ… ì¶”ê°€!
      return;
    }

    const data = await res.json();
    diaryList.innerHTML = "";

    data.forEach(d => {
      const li = document.createElement("li");
      li.innerHTML = `
        <strong>${d.title}</strong><br>
        ${d.content.replace(/\n/g,'<br>')}
        <br><small>ğŸ•’ ${new Date(d.createdAt).toLocaleString()}</small>
        <button onclick="deleteDiary(${d.id})" style="margin-left:10px;">ğŸ—‘ï¸ ì‚­ì œ</button>
      `;
      diaryList.appendChild(li);
    });
  }

  document.getElementById("sort").addEventListener("change", loadDiaries);
</script>

</body>
</html>
