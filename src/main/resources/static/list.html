<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>📋 일기 목록</title>
  <link rel="stylesheet" href="/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
</head>

<body>

<nav class="nav-bar">
  <h1 class="nav-title">📘 나의 일기장</h1>
  <div class="nav-menu">
    <a href="/index.html">🏠 홈</a>
    <a href="/write.html">✍️ 작성</a>
    <button id="logoutBtn" style="margin-left:10px; display: none;">Logout</button>
  </div>
</nav>

<main class="main-content">
  <h2>📋 일기 목록</h2>
  <label for="sort">정렬:</label>
  <select id="sort">
    <option value="desc">최신순</option>
    <option value="asc">오래된순</option>
  </select>
  <ul id="diary-list"></ul>
</main>

<!-- ✅ 로그인 안내 모달 -->
<div id="modal-backdrop" style="display: none;">
  <div id="modal-box" style="display: none;">
    <p>로그인이 필요합니다 😅</p>
    <button id="modal-ok">로그인하러 가기</button>
  </div>
</div>

<script>
  // ✅ 로그인 확인 → 로그아웃 버튼 표시 & 목록 로드
  fetch("/users/me", { credentials: "include" })
    .then(res => {
      if (res.ok) {
        document.getElementById("logoutBtn").style.display = "inline-block";
        loadDiaries();
      } else {
        document.getElementById("modal-backdrop").style.display = "block";
        document.getElementById("modal-box").style.display = "block"; // ✅ 추가!
      }
    });

  // ✅ 로그아웃 버튼 동작
  document.getElementById("logoutBtn").onclick = async () => {
    await fetch('/users/logout', { method: 'POST', credentials: 'include' });
    location.href = '/login.html';
  };

  document.getElementById("modal-ok").onclick = () => {
    location.href = "/login.html";
  };

  const diaryList = document.getElementById("diary-list");

  async function deleteDiary(id) {
    const res = await fetch(`/diaries/${id}`, {
      method: "DELETE",
      credentials: "include"
    });
    if (res.ok) loadDiaries();
    else if (res.status === 401) {
      document.getElementById("modal-backdrop").style.display = "block";
      document.getElementById("modal-box").style.display = "block"; // ✅ 추가!
    }
  }

  async function loadDiaries() {
    const sort = document.getElementById("sort").value;
    const res = await fetch(`/diaries?sort=${sort}`, {
      credentials: "include"
    });

    if (res.status === 401) {
      document.getElementById("modal-backdrop").style.display = "block";
      document.getElementById("modal-box").style.display = "block"; // ✅ 추가!
      return;
    }

    const data = await res.json();
    diaryList.innerHTML = "";

    data.forEach(d => {
      const li = document.createElement("li");
      li.innerHTML = `
        <strong>${d.title}</strong><br>
        ${d.content.replace(/\n/g,'<br>')}
        <br><small>🕒 ${new Date(d.createdAt).toLocaleString()}</small>
        <button onclick="deleteDiary(${d.id})" style="margin-left:10px;">🗑️ 삭제</button>
      `;
      diaryList.appendChild(li);
    });
  }

  document.getElementById("sort").addEventListener("change", loadDiaries);
</script>

</body>
</html>
