<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“‹ ì¼ê¸° ëª©ë¡</title>
  <link rel="stylesheet" href="/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
</head>

<body>

<!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
<nav class="nav-bar">
  <h1 class="nav-title">ğŸ“˜ ë‚˜ì˜ ì¼ê¸°ì¥</h1>
  <div class="nav-menu">
    <a href="/index.html">ğŸ  í™ˆ</a>
    <a href="/write.html">âœï¸ ì‘ì„±</a>
    <!-- ğŸ”’ ë¡œê·¸ì¸ëœ ì‚¬ëŒë§Œ ë³´ì´ëŠ” ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ (ì²˜ìŒì—” ìˆ¨ê¹€) -->
    <button id="logoutBtn" style="margin-left:10px; display: none;">Logout</button>
  </div>
</nav>

<!-- ë³¸ë¬¸ ë‚´ìš© -->
<main class="main-content">
  <h2>ğŸ“‹ ì¼ê¸° ëª©ë¡</h2>

  <!-- ì •ë ¬ ë°©ì‹ ì„ íƒ -->
  <label for="sort">ì •ë ¬:</label>
  <select id="sort">
    <option value="desc">ìµœì‹ ìˆœ</option>
    <option value="asc">ì˜¤ë˜ëœìˆœ</option>
  </select>

  <!-- ğŸ“‹ ì¼ê¸° í•­ëª©ë“¤ì´ ë“¤ì–´ê°ˆ ìë¦¬ -->
  <ul id="diary-list"></ul>
</main>

<!-- ë¡œê·¸ì¸ ì•ˆë‚´ ëª¨ë‹¬ (ë¡œê·¸ì¸ ì•ˆ ëì„ ë•Œ í‘œì‹œ) -->
<div id="modal-backdrop" style="display: none;">
  <div id="modal-box" style="display: none;">
    <p>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤ ğŸ˜…</p>
    <button id="modal-ok">ë¡œê·¸ì¸í•˜ëŸ¬ ê°€ê¸°</button>
  </div>
</div>

<script>
  // âœ… ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸ í›„ ì²˜ë¦¬
  fetch("/users/me", { credentials: "include" })
    .then(res =>
    {
      if (res.ok)
      {
        // ğŸ” ë¡œê·¸ì¸ ë˜ì–´ìˆìœ¼ë©´ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ë³´ì´ê³ , ì¼ê¸° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤í–‰
        document.getElementById("logoutBtn").style.display = "inline-block";
        loadDiaries();
      } else
      {
        // âŒ ë¡œê·¸ì¸ ì•ˆ ë˜ì–´ìˆìœ¼ë©´ ëª¨ë‹¬ ë³´ì—¬ì¤Œ
        document.getElementById("modal-backdrop").style.display = "block";
        document.getElementById("modal-box").style.display = "block";
      }
    });

  // âœ… ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­ ì‹œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
  document.getElementById("logoutBtn").onclick = async () =>
  {
    await fetch('/users/logout',
    {
      method: 'POST',
      credentials: 'include'
    });
    location.href = '/login.html';
  };

  // âœ… ëª¨ë‹¬ì—ì„œ "ë¡œê·¸ì¸í•˜ëŸ¬ ê°€ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ
  document.getElementById("modal-ok").onclick = () =>
  {
    location.href = "/login.html";
  };

  const diaryList = document.getElementById("diary-list");

  // ğŸ—‘ï¸ ì¼ê¸° ì‚­ì œ í•¨ìˆ˜
  async function deleteDiary(id)
  {
    const res = await fetch(`/diaries/${id}`,
    {
      method: "DELETE",
      credentials: "include"
    });

    if (res.ok)
    {
      loadDiaries();  // ì‚­ì œ í›„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
    } else if (res.status === 401)
    {
      // âŒ ë¡œê·¸ì¸ ë§Œë£Œ â†’ ëª¨ë‹¬ í‘œì‹œ
      document.getElementById("modal-backdrop").style.display = "block";
      document.getElementById("modal-box").style.display = "block";
    }
  }

  // ğŸ“¥ ì¼ê¸° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadDiaries()
  {
    const sort = document.getElementById("sort").value;  // ì •ë ¬ ë°©ì‹ ê°€ì ¸ì˜¤ê¸°

    const res = await fetch(`/diaries?sort=${sort}`,
    {
      credentials: "include"
    });

    if (res.status === 401)
    {
      // âŒ ì„¸ì…˜ ë§Œë£Œ â†’ ëª¨ë‹¬ í‘œì‹œ
      document.getElementById("modal-backdrop").style.display = "block";
      document.getElementById("modal-box").style.display = "block";
      return;
    }

    const data = await res.json();
    diaryList.innerHTML = "";  // ê¸°ì¡´ ëª©ë¡ ì§€ìš°ê¸°

    // ğŸ” ë°›ì•„ì˜¨ ì¼ê¸°ë“¤ì„ í™”ë©´ì— í‘œì‹œ
    data.forEach(d =>
    {
      const li = document.createElement("li");
      li.innerHTML = `
        <strong>${d.title}</strong><br>
        ${d.content.replace(/\n/g,'<br>')}
        <br><small>ğŸ•’ ${new Date(d.createdAt).toLocaleString()}</small>
        <button onclick="deleteDiary(${d.id})" style="margin-left:10px;">ğŸ—‘ï¸ ì‚­ì œ</button>
      `;
      diaryList.appendChild(li);
    });
  }

  // ğŸ” ì •ë ¬ ë°©ì‹ì´ ë°”ë€Œë©´ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
  document.getElementById("sort").addEventListener("change", loadDiaries);
</script>

</body>
</html>
